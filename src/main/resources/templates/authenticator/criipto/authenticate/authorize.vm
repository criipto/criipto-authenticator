#*
*  Copyright 2018 Curity AB
*
*  Licensed under the Apache License, Version 2.0 (the "License");
*  you may not use this file except in compliance with the License.
*  You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
*  Unless required by applicable law or agreed to in writing, software
*  distributed under the License is distributed on an "AS IS" BASIS,
*  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
*  See the License for the specific language governing permissions and
*  limitations under the License.
*#

#set($_cspChildSrc = "child-src 'self' curity.criipto.id bankid:;")

#define ($_body)
    #parse("fragments/jquery")
        <script type="text/javascript" $!nonceAttr>

            function handleUserData(data) {
                addField("code", data.code);
                addField("state", data.state);
                addField("error", data.error);
                addField("error_description", data.error_description);

                $("#dataForm").submit();
            }

            function addField(name, value) {
                if (value) {
                    var input = $("<input>")
                            .attr("type", "hidden")
                            .attr("id", name)
                            .attr("name", name).val(value);
                    $('#dataForm').append($(input));
                }
            }
        </script>

        <p class="h4 mb4 semibold center" id="poll_message">#message("${_templatePrefix}.view.title")</p>

        <iframe id="autoStart" height="0" width="0" frameborder="0"></iframe>

        <div class="px4 mb4">
            <div class="loader center">
                <div class="loader-inner ball-pulse">
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
            </div>
        </div>

        <form class="manuallink pb0 display-none">
            <p class="h4 center">#message("${_templatePrefix}.view.manualstart")</p>
            <a class="button button-fullwidth button-primary center" id="manualStart" type="submit">
                #message("${_templatePrefix}.view.button.manualstart")</a>
        </form>
        <form name="cancel" action="$!cancelAction" class="manuallink display-none" method="get">
            <button type="submit" class="button button-fullwidth button-danger-outline">#message($_messages,
                "${_templatePrefix}.view.button.cancel")</button>
        </form>
        <form action="$_action" method="post" id="pollingDone" class="display-none">
            <input type="hidden" name="_pollingDone" value="true"/>
        </form>

    #parse("authenticator/bankid/launch/bankid-launcher")

    <iframe id="iframeId" src="$!authorizeUrl" height="0" width="0" class="display-none"></iframe>

    <form id="dataForm" action="$_authUrl/callback" method="post"></form>

    <script src="$_staticResourceRootPath/assets/js/lib/jquery-2.1.4.min.js"></script>
    <script src="$_staticResourceRootPath/assets/js/curity.js"></script>
#end

#parse("layouts/default")
